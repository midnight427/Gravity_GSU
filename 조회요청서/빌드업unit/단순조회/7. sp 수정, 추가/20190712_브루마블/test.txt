USE [STATE]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[usp_RO1_MARBLE_Event_ItemSet_T]
	@AID INT,
	@ItemID INT,
	@ItemCNT INT
AS
SET NOCOUNT ON
BEGIN
	EXEC STATE.dbo.SET_MARBLE_INS_T @AID,@ItemID,@ItemCNT
END
SET NOCOUNT OFF 


-----
GRANT EXECUTE ON [dbo].[usp_RO1_MARBLE_Event_ItemSet_T] TO [WebUser]


-----


USE [STATE]
GO
/****** Object:  StoredProcedure [dbo].[set_marble_ins]    Script Date: 07/11/2019 18:53:51 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[SET_MARBLE_INS_T]
@AID	INT,
@ItemID	INT,
@ItemCNT INT
	
AS

SET NOCOUNT ON

-- 존다NPC 아이템 생성(QA팀 테스터 포함)  
-- 아이템 만료일자는 1개월로 지정(운영팀요청)
 DECLARE @I_expireDate datetime
 SET @I_expireDate = DATEADD(month,1,getdate())
 --SET @I_expireDate = '2019-01-02 23:59:59.000'
 
 DECLARE @Mid BIGINT

--RODEX 지급 Log 기록
 INSERT INTO EventDB.dbo.EventDB_T(regDate, AID, GID, ItemID,ItemCNT, SvrName, LoginDate,remark,NUM)  
 Values (getdate(), @AID, 0,@ItemID,@ItemCNT,'',GETDATE(),'블루마블(2019/07/24~08/28)'
 ,(select COUNT(AID) from EventDB.dbo.EventDB_T where AID = @AID and remark = '블루마블(2019/07/24~08/28)')+1)

 INSERT INTO Globalinfo.dbo.RoDex_T (AID, Sendername, title,text, itemid, itemcnt,ExpireDate)
 VALUES (@AID,'운영진','블루마블이벤트','당첨을 축하 드립니다',@ItemID,@ItemCNT,@I_expireDate)

 IF 0 < @@ROWCOUNT        
	BEGIN		
		
		SET @Mid = SCOPE_IDENTITY()      
			   
		INSERT INTO [MobileEventLog].[dbo].[RoDexLog_T]( [MID],[AID],[SenderCharName],[ItemID],[ItemCount],[ExpireDate] )               
		VALUES( @Mid, @AID,'운영진',@ItemID,@ItemCNT,@I_expireDate )   
	END

SET NOCOUNT OFF

---------------------------------------------

GRANT EXECUTE ON [dbo].[SET_MARBLE_INS_Z_T] TO [WebUser]

---------------------------------------------

select * into EventDB_T from EventDB_NO

select * into EventDB_T from EventDB_NO where 1=2 

insert into  EventDB_T from EventDB_NO
